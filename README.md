Firebird Streaming
==================

Проект Firebird Streaming - это набор библиотек для разбора логов репликации Firebird после обработки их утилитой `fb_repl_print`. На каждое событие в логе можно написать свой обработчик унаследовав интерфейс SegmentProcessEventListener.

Данная библиотека может применяться для оповещения о событиях через систему очередей, или для написания собственного репликатора в другие СУБД.

Альфа релиз можно скачать по ссылке https://github.com/sim1984/fbstreaming/files/7101299/release.zip

Папка `journals/incoming` содержит логи репликации после обработки их утилитой `fb_repl_print`.

Папка `journals/outgoing` некоторые выходные файлы, которые являются результатом работы одного из плагинов.

Файл `/journals/segments.journal` файл в который записываются имена файлов обработанных сегментов. Используется некоторыми плагинами.

JAR файлы содержащие плагины расположены в папке `plugins`.
В примере имеются следующие плагины:
* преобразование сегментов репликации в формат JSON
* отправка связанных данных DML операторов (в формате JSON) в очередь RabbitMQ по событию подтверждения транзакции
* запись DML операторов в SQL файлы. Запись происходит по событию подтверждения транзакции.

Для настройки используется файл `config.properties`.
Свойства в файле конфигурации:
* `pluginClassName` - полное имя класса плагина
* `incomingFolder` - папка со входными журналами (сегментами репликации)
* `outgoingFolder` - папка с результатами работы плагина (используется плагинами JSON и SQL)
* `journalFileName` - файл с обработанными сегментами репликации (используется плагинами SQL и RabbitMQ)
* `segmentFileNameMask` - маска для входных файлов (сегментов репликации)
* `segmentFileCharset` - кодировка сегментов репликации
* `includeTables` - регулярное выражение для фильтрации таблиц (если не задано обрабатываются все таблицы)
* `rabbit.host` - хот для плагина RabbitMQ
* `rabbit.queueName` - имя очереди для плагина RabbitMQ

## Описание плагина json

Полное имя плагина `com.hqbird.fbstreaming.plugin.json.JsonStreamPlugin`

Плагин `JsonStreamPlugin` читает файлы сегментов репликации и сохраняет данные DML операторов над таблицами в формате JSON. Для каждого файла сегмента репликации создаётся файл с данными в формате JSON. JSON файлы сохраняются в папке которая прописана в параметре `outgoingFolder`.

Файл JSON имеет следующий формат. 

```
[
  {
    "transactionNumber": 409036118,
    "statements": [
      {
        "tableName": "CLBULLETS",
        "statementType": "INSERT",
        "keyValues": {
          "NUMBULL": 156803509
        },
        "newFieldValues": {
          "CLAGE": 45,
          "REPL$GRPID": 15,
          "PROFID": 990000090,
          "SENDSTATUS": 0,
          "POL": 1,
          "FILIAL": 15,
          "BDATE": "1976-05-03",
          "CLINICID": 38,
          "PRIMLIST": 1,
          "MODIFYDATE": "16-AUG-2021 23:50:14.2480",
          "DGOPEN": 14438,
          "DATEOPEN": "16-AUG-2021",
          "TREATCODE": 156802708,
          "PCODE": 150002994,
          "ISSUEDATE": "16-AUG-2021",
          "DISABILITYID": 150050614,
          "DCODEOPEN": 150000278,
          "NUMBULL": 156443509
        },
        "oldFieldValues": {}
      },
      ...
    ]
  },
  ....
]
```

JSON файл на верхнем уровне представляет собой массив транзакций. Для каждой
транзакции сохраняется её номер в ключе `transactionNumber`. В ключе `statements` сохраняется массив с описанием всех DML операторов над таблицами произведённых в рамках этой транзакции. Для каждого DML оператора сохраняются следующие данные:
* `tableName` - имя таблицы над которой осуществляется операция;
* `statementType` - тип оператора (INSERT, UPDATE, DELETE);
* `keyValues` - значения ключевых полей;
* `newFieldValues` - новые значения полей;
* `oldFieldValues` - старые значения полей.

## Описание плагина sql

Полное имя плагина `com.hqbird.fbstreaming.plugin.sql.SqlStreamPlugin`

Плагин `SqlStreamPlugin` читает файлы сегментов репликации и сохраняет их в файлы с DML операторами в виде SQL. Для каждого транзакции из сегмента репликации создаётся файл с SQL операторами в формате SQL. SQL файлы сохраняются в папке которая прописана в параметре `outgoingFolder`.

SQL хранит скрипт DML операторов которые разделены `;`. BLOB подтипа TEXT преобразуется в символьный литерал, если подтип BINARY, то преобразуется в бинарный литерал в 16-ричном виде. Внимание для BLOB длиннее 65535 байт будет сгенерирован ошибочный скрипт. Это планируется исправить в будущем.

## Описание плагина rabbitmq

Полное имя плагина `com.hqbird.fbstreaming.plugin.rabbitmq.RabbitMQStreamPlugin`